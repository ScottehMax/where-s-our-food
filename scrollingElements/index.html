<html>
<head>

    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="jquery.onepage-scroll.min.js"></script>
    <script type="text/javascript" src="/socket.io/socket.io.js"></script>
    <meta charset="utf-8">
    <link rel="stylesheet" href="bootstrap.min.css">
    <link rel="stylesheet" href="bootstrap-theme.min.css">
    <link rel='stylesheet' href='onepage-scroll.css' type='text/css'>
    <link rel="stylesheet" href="style.css">
    <script>

        var socket = io.connect('http://localhost:8080');
        socket.on('test', function (data) {
            console.log(data);
            socket.emit('my other event', { my: 'data' });
        });

        $(document).ready(function(){
            $("#fullpage").onepage_scroll({
                sectionContainer: "section",
                easing: "cubic-bezier(.66,.01,.4,.98)",
                loop: false
            });
        });

        var clipAudio = [
            [null, null],
            [new Audio('sounds/guitar_c_penta/1.wav'),new Audio('sounds/guitar_c_penta/1.wav')],
            [new Audio('sounds/guitar_c_penta/2.wav'),new Audio('sounds/guitar_c_penta/2.wav')],
            [new Audio('sounds/guitar_c_penta/3.wav'),new Audio('sounds/guitar_c_penta/3.wav')],
            [new Audio('sounds/guitar_c_penta/4.wav'),new Audio('sounds/guitar_c_penta/4.wav')],
            [new Audio('sounds/guitar_c_penta/5.wav'),new Audio('sounds/guitar_c_penta/5.wav')],
            [new Audio('sounds/guitar_c_penta/6.wav'),new Audio('sounds/guitar_c_penta/6.wav')],
            [new Audio('sounds/guitar_c_penta/7.wav'),new Audio('sounds/guitar_c_penta/7.wav')],
            [new Audio('sounds/guitar_c_penta/8.wav'),new Audio('sounds/guitar_c_penta/8.wav')]
        ];
        var clipAudioNum = 2;
        function playNote(note){

            if (note!=0) {
                clipAudioNum++;
                var mod = clipAudioNum % 2;
                clipAudio[note][mod].play();
            }
            timesPlayed += 1;

        }

        var chosenDrums = 1;

        function startDrumCount(){
            var secondsLeft;
            //Fade out button
            $('#startDrumCount').animate({
                opacity: 0
            }, 500);

            //Initialise vote count array
            votes = [0,0,0,0];

            var socket = io('http://localhost:8080');
            socket.on('drumVote', function (data) {
                votes[data.drumInt]++;
            });

            targetDate = new Date().getTime() + 80000;

            //initialise timer with 80 secs
            $('#countdown').html("80 seconds left");

            //Creates a countdown timer
            var cdInterval = setInterval(function(){
                var currentDate = new Date().getTime();
                var secondsLeft = Math.round((targetDate - currentDate) / 1000);
                if(secondsLeft >= 0){
                    $('#countdown').html(secondsLeft + " seconds left");
                } else {
                    clearInterval(cdInterval);
                    clearInterval(refreshInterval);
                }
            }, 1000);

            //Interval for testing purposes only
            var refreshInterval = setInterval(function(){
                total = 0;

                for (var i = 0; i < (votes.length); i++) {
                    total += votes[i];
                }

                createGraph(votes, total);
            }, 1000);
        }

        function createGraph(votes, total){
            var firstScore = document.getElementById("firstScore");
            var secondScore = document.getElementById("secondScore");
            var thirdScore = document.getElementById("thirdScore");
            var fourthScore = document.getElementById("fourthScore");
            //firstScore.style.width = input[1] / total * 100 + "%";
            $("#firstScore").animate({width: votes[0] / total * 100 + "%"}, 400);
            $("#secondScore").animate({width: votes[1] / total * 100 + "%"}, 400);
            $("#thirdScore").animate({width: votes[2] / total * 100 + "%"}, 400);
            $("#fourthScore").animate({width: votes[3] / total * 100 + "%"}, 400);
            firstScore.innerHTML = Math.round(votes[0] / total * 100) + "%";
            secondScore.innerHTML = Math.round(votes[1] / total * 100) + "%";
            thirdScore.innerHTML = Math.round(votes[2] / total * 100) + "%";
            fourthScore.innerHTML = Math.round(votes[3] / total * 100) + "%";
         }

         function resetGraph(){
            $("#firstScore").animate({width: 1 + "%"}, 400);
            $("#secondScore").animate({width: 1 + "%"}, 400);
            $("#thirdScore").animate({width: 1 + "%"}, 400);
            $("#fourthScore").animate({width: 1 + "%"}, 400);
         }

         //
         var timesPlayed = 0;

         //array that stores the notes
         noteArray = [6,4,5,6,5,4,3,4,6,4,5,6,5,4,3,4];

         function playSampleNotes() {
             for(i=0; i<noteArray.length; i++){
                 (function(i){
                     setTimeout(function(){
                         playNote(noteArray[i]);
                     }, 300 * i);
                 }(i));
             }
         }

        /*
        function listenForMelody(){
            var socket = io('http://localhost:3000/');
            socket.on('connection', function(data){
                socket.emit('setWhatToFind', { 'whatToFind' : 'melody' });
            });
        }
        */

        var audio = null;
        var drumInterval = null;

        function playDrums(ind){
            stopDrums();

            //audioArr.append(audio);

            audio = new Audio('sounds/db' + ind + '.wav');
            audio.play();

            drumInterval = setInterval(function(){
                audio = new Audio('sounds/db' + ind + '.wav');
                audio.play();
            }, 2400);
        }

        function playDrumsOnce(){
            stopDrums();

            audio = new Audio('sounds/db' + chosenDrums + '.wav');
            audio.play();
        }

        function stopDrums(){
            if(audio != null){
                audio.pause();
                clearInterval(drumInterval);
            }
            audio = null;
        }

        var notesSix = [0,0,0,0,0,0,0,0,
                        0,0,0,0,0,0,0,0,
                        1,2,3,4,5,6,7,8,
                        0,0,0,0,0,0,0,0,
                        0,0,0,0,0,0,0,0,
                        0,0,0,0,0,0,0,0];

        var namesSix = ['','','','','',''];

        var queue = [];

        function triggerNotes(){
            var drumAudio = new Audio('sounds/db' + chosenDrums + '.wav');

            for(var i=16; i<24; i++){
                (function(i){
                    setTimeout(function(){
                        drumAudio.play();
                        playNote(notesSix[i]);
                    }, 300 * i);
                }(i));
            }
        }

        function trigger(){
            var drumAudio = new Audio('sounds/db' + chosenDrums + '.wav').play();
            noteArr = [2,0,2,3,4,3,6,5];
            playNote(noteArr[0]);
            setTimeout(function(){
                for(var i in noteArr) {
                    playNote(noteArr[i+1]);
                }
            }, 300);
        }

        function queueBar(inputName, inputNotes){
            var postName = inputName;
            var notes = inputNotes;

            var queueObj = new Object({});
            queueObj.postName = postName;
            queueObj.notes = notes;

            queue.unshift(queueObj);
            console.log(JSON.stringify(queueObj) + " queued");
        }

        function setUpScroller(){
            setInterval(function(){
                triggerNotes();

                namesSix.shift();
                notesSix.shift();
                if(queue.length >= 1){
                    namesSix.push(queue[0].postName);
                    notesSix.concat(queue[0].notes);
                } else {
                    namesSix.push('');
                    notesSix.concat([0,0,0,0,0,0,0,0]);
                }
            }, 2400);
        }

        function createScroller(){

        }

        function listenForMelody(){
            socket.on('melodyPush', function(data){
                queueBar(data.postName, data.notes);
            });
        }

    </script>
    <script>
            function add_data(input) {
                var obj=document.getElementById(input)
                obj.value+="\n"+"blah test";
                $("#textarea1").animate({
                    scrollTop:$("#textarea1")[0].scrollHeight - $("#textarea1").height()
                },700);
            }

    </script>
</head>
<body>
    <div id="fullpage">
        <section>
            <div class="cont">
                <span class="title">Where's Our Sound?</span><br>
                <span class="subtitle">#DoYouHaveTheGUTS 2014</span>
                <div class="sep"></div>
                <div class="sep"></div>
                <span class="letter" style="margin-left: 0">
                    Collabarative music composition using the SendGrid API<br>
                </span>
                <div class="sep"></div>
                <div class="sep"></div>
                <span class="regText">
                    Team Where's-Our-Food<br>
                </span>
            </div>
        </section>
        <section>
            <div class="cont">
                <span class="title">Drum Beat Choices</span><br>
                <span class="subtitle">Listen to the following drum loops</span><br><br>

                <span class="letter">A</span>
                <audio controls loop="true">
                    <source src="sounds/db1.wav" type="audio/ogg">
                </audio>
                <br><br>

                <span class="letter">B</span>
                <audio controls loop="true">
                    <source src="sounds/db2.wav" type="audio/ogg">
                </audio>
                <br><br>

                <span class="letter">C</span>
                <audio controls loop="true">
                    <source src="sounds/db3.wav" type="audio/ogg">
                </audio>
                <br><br>

                <span class="letter">D</span>
                <audio controls loop="true">
                    <source src="sounds/db4.wav" type="audio/ogg">
                </audio>
                <br>

            </div>
        </section>
        <section>
            <div class="cont">
                <span class="title">Select Your Preferred Beat</span><br>
                <span class="subtitle">Email wts@bymail.in</span><br><br>

                <div class="statusBar regText" style="margin-top: -20px; margin-bottom: 30px">
                    <div id="countdown"></div>
                </div>

                <span class="letter">A</span>
                <div class="statusBar progress progress-striped active">
                    <div class="progress-bar" id="firstScore"></div>
                </div>
                <span class="letter">B</span>
                <div class="statusBar progress progress-striped active">
                    <div class="progress-bar" id="secondScore"></div>
                </div>
                <span class="letter">C</span>
                <div class="statusBar progress progress-striped active">
                    <div class="progress-bar" id="thirdScore"></div>
                </div>
                <span class="letter">D</span>
                <div class="statusBar progress progress-striped active">
                    <div class="progress-bar" id="fourthScore"></div>
                </div>

                <a href="#" id="startDrumCount" class="btn btn-primary" onclick="startDrumCount()">Open Voting</a>
            </div>
        </section>
        <section>
            <div class="cont">
                <span class="title">Now It's Time For Melodies</span><br>
                <span class="subtitle">Email your melody chains to wts@bymail.in</span><br>
                <div class="sep"></div>
                <span class="regText">
                    A melody chain is an 8 digit number, each digit representing half a beat. <b>1 - 8</b> represent different notes ascending in pitch and <b>0</b> represents a break.<br>
                </span>
                <div class="sep"></div>
                <span class="regText">
                    <b>Example String: </b>24804060<br>
                    <a href="#" id="playSampleNotes" class="btn btn-primary" onclick="playSampleNotes()">Listen</a>
                    <a href="#" id="startDrumCount" class="btn btn-primary" onclick="listenForMelody()">listenForMelody</a>
                </span>
            </div>
        </section>
        <section>
            <div class="cont">
                <span class="title">Where's Our Sound?</span><br>
                <span class="subtitle">#DoYouHaveTheGUTS 2014</span>

                <div id="scroller"></div>
                <textarea rows="3" id="textarea1"></textarea>
                <br><input type="button" value="Text" onclick="add_data('textarea1')">
            </div>
        </section>
    </div>
</body>
</html>
